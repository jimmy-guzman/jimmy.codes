---
import { getCollection } from "astro:content";
import type { GetStaticPaths } from "astro";

import BackLink from "@/components/BackLink.astro";
import MetaLine from "@/components/MetaLine.astro";
import Tags from "@/components/Tags.astro";
import { BASE_TITLE } from "@/configs/pages";
import BaseLayout from "@/layouts/BaseLayout.astro";
import PageLayout from "@/layouts/PageLayout.astro";
import { readingTime, sortByPublishDate } from "@/utils/content";
import { shortTitle } from "@/utils/post";
import { getAllTags, slugifyTag } from "@/utils/tag";

export const getStaticPaths = (async () => {
  const allPosts = await getCollection("posts");
  const allTags = getAllTags(allPosts);

  return allTags.map((originalTag) => ({
    params: { slug: slugifyTag(originalTag) },
    props: {
      originalTag,
      allPosts,
      allTags,
    },
  }));
}) satisfies GetStaticPaths;

const { slug } = Astro.params;
const { originalTag, allPosts, allTags } = Astro.props;

const posts = allPosts
  .filter((post) => post.data.tags.some((tag) => slugifyTag(tag) === slug))
  .sort(sortByPublishDate);

const pageHeading = `Posts tagged "${originalTag}"`;
const pageTitle = `${pageHeading} | ${BASE_TITLE}`;
const pageDescription = `All blog posts tagged with "${originalTag}"`;
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  keywords={[originalTag, "blog", "posts"]}
>
  <PageLayout heading={pageHeading}>
    <Tags tags={allTags} active={slug} />

    <section class="not-prose">
      {
        posts.length > 0 ? (
          <ul class="flex flex-col gap-y-4">
            {posts.map((post) => (
              <li class="space-y-0.5">
                <a
                  href={`/blog/${post.slug}`}
                  class="link font-medium link-hover"
                  rel="bookmark"
                  data-astro-prefetch
                >
                  {shortTitle(post)}
                </a>
                <MetaLine
                  class="block text-sm text-muted"
                  publishDate={post.data.publishDate}
                  minutes={readingTime(post.body)}
                  filePath={post.filePath}
                />
              </li>
            ))}
          </ul>
        ) : (
          <p class="text-muted">No posts found for this tag.</p>
        )
      }
    </section>

    <section class="mt-8">
      <p>
        <BackLink url="/blog" title="blog" />
      </p>
    </section>
  </PageLayout>
</BaseLayout>
