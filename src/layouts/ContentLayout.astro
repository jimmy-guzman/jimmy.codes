---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import BackLink from "@/components/BackLink.astro";
import LastModified from "@/components/LastModified.astro";
import MetaLine from "@/components/MetaLine.astro";
import Tags from "@/components/Tags.astro";
import { urls } from "@/configs/urls";

import "rehype-callouts/theme/github";

interface Props {
  title: string;
  tags: { tag: string; count: number }[];
  publishDate: Date;
  updatedDate?: Date;
  minutes: number;
  filePath?: string;
  relatedPosts: { slug: string; title: string }[];
  slug: string;
}

const {
  title,
  publishDate,
  updatedDate,
  minutes,
  filePath,
  tags,
  relatedPosts,
  slug,
} = Astro.props;

const emailSubject = encodeURIComponent(`Feedback on "${title}"`);

const images = import.meta.glob<{ default: ImageMetadata }>(
  "/src/assets/images/posts/*",
  { eager: true },
);
const srcImage = images[`/src/assets/images/posts/${slug}.png`]?.default;
---

<section>
  <p class="text-sm text-muted">
    <MetaLine publishDate={publishDate} minutes={minutes} />
  </p>
</section>

<div class="divider" aria-hidden="true" role="presentation"></div>

<article>
  {
    srcImage && (
      <figure>
        <Image
          src={srcImage}
          alt={`Cover image for ${title}`}
          class="h-auto w-full"
          loading="eager"
          fetchpriority="high"
          widths={[400, 696, 1392]}
          sizes="(max-width: 768px) 400px, (min-resolution: 2dppx) 1392px, 696px"
          format="webp"
        />
        <figcaption class="text-muted">Image crafted by robots</figcaption>
      </figure>
    )
  }
  <slot />
</article>

<section class="mt-8">
  <Tags tags={tags} />
</section>

{
  relatedPosts.length > 0 && (
    <aside class="mt-8" aria-labelledby="related-heading">
      <h2 id="related-heading">Related Posts</h2>
      <ul>
        {relatedPosts.map((post) => (
          <li>
            <a href={`/blog/${post.slug}`}>{post.title}</a>
          </li>
        ))}
      </ul>
    </aside>
  )
}

<section class="mt-8" aria-labelledby="discuss-heading">
  <h2 id="discuss-heading">Let's Discuss</h2>
  <p>
    Questions or feedback? <a href={`${urls.email}?subject=${emailSubject}`}
      >Send me an email</a
    >.
  </p>
</section>

<a
  href="#"
  class="btn fixed right-6 bottom-6 btn-circle shadow-lg btn-ghost"
  aria-label="Back to top"
>
  <span class="icon-[lucide--arrow-up] h-4 w-4" aria-hidden="true"></span>
</a>

{
  updatedDate && (
    <section class="mt-8 flex justify-end text-sm text-muted">
      <LastModified updatedDate={updatedDate} filePath={filePath} />
    </section>
  )
}

<section class="mt-8">
  <p>
    <BackLink url="/blog" title="blog" />
  </p>
</section>
